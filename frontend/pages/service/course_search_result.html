<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Search Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/motion-tailwind/motion-tailwind.css">
</head>
<body>
<header id="header" class="header-style group"></header>
<main class="container mx-auto px-4 py-8">
    <h1 class="custom-heading mb-4 fade-in">Course Search Results</h1>

    <div class="mb-4 fade-in">
        <span class="middle-heading">Keyword:</span>
        <span id="search-keyword" class="font-bold text-primary"></span>
    </div>

    <div id="course-list" class="space-y-4">
        <!-- This area will display matched courses -->
    </div>

    <div id="pagination-controls" class="flex gap-2 mt-4 justify-center"></div>
</main>
<footer id="footer" class="custom-footer"></footer>
<script src="/js/components/layout.js"></script>
<script type="module">
    import {fetchWithPagination} from '/js/components/common.js';

    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name) || '';
    }

    const keyword = getQueryParam('keyword');
    document.getElementById('search-keyword').textContent = keyword;

    async function loadCourses(page = 1, perPage = 10) {
        try {
            const result = await fetchWithPagination('/api/courses/search', {keyword}, page, perPage);

            const courseList = document.getElementById('course-list');
            courseList.innerHTML = '';

            if (!result.data.length) {
                courseList.innerHTML = '<div class="alert-card-blue fade-in"><p>No matching courses found.</p></div>';
                return;
            }

            result.data.forEach((course, index) => {
                const card = document.createElement('div');
                card.className = 'card glass-card card-hover hover-scale fade-in';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="course-card-title">${course.name}</h3>
                                <span class="badge ${getStatusBadgeClass(course.status)}">${course.status}</span>
                            </div>
                            <p class="typography-default mb-2">${course.description || "No description."}</p>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="tag">${course.code}</span>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <a href="/pages/service/course_details_page.html?code=${course.code}" class="custom-small-btn hover-up">
                                    View Details
                                </a>
                                ${course.status === "PENDING" ? `
                                    <button class="custom-small-btn hover-up" onclick="vote('${course.code}', true)">
                                        üëçAgree (${course.agree_votes || 0})
                                    </button>
                                    <button class="custom-small-btn hover-up" onclick="vote('${course.code}', false)">
                                        üëé Disagree (${course.disagree_votes || 0})
                                    </button>
                                ` : ""}
                            </div>
                        </div>
                    </div>
                `;
                courseList.appendChild(card);
            });

            renderPagination(result.pagination.page, result.pagination.pages, perPage);
        } catch (error) {
            console.error('Error loading courses:', error);
            document.getElementById('course-list').innerHTML =
                '<div class="alert-card-yellow fade-in"><p class="text-red-500">Error loading search results.</p></div>';
        }
    }

    async function vote(courseCode, agree) {
        try {
            const res = await fetch(`/api/courses/${courseCode}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({agree})
            });
            const result = await res.json();
            if (result.success) {
                alert(`Vote submitted. Status: ${result.result.status}`);
                loadCourses();
            } else {
                alert(result.message || 'Vote failed');
            }
        } catch (err) {
            console.error("Vote error:", err);
            alert("Network error");
        }
    }
    window.vote = vote;

    function getStatusBadgeClass(status) {
        switch (status) {
            case "ACTIVE":
                return "badge-green";
            case "PENDING":
                return "badge-yellow";
            case "REJECTED":
                return "badge-red";
            default:
                return "badge-gray";
        }
    }

    function renderPagination(currentPage, totalPages, perPage) {
        const pagination = document.getElementById('pagination-controls');
        pagination.innerHTML = '';

        if (currentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.className = 'custom-small-btn hover-up';
            prevBtn.onclick = () => loadCourses(currentPage - 1, perPage);
            pagination.appendChild(prevBtn);
        }

        if (currentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.className = 'custom-small-btn hover-up';
            nextBtn.onclick = () => loadCourses(currentPage + 1, perPage);
            pagination.appendChild(nextBtn);
        }
    }

    loadCourses();
</script>
</body>
</html>