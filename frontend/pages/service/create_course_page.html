<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - UWA Course Evaluation</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/motion-tailwind/motion-tailwind.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="/js/components/common.js"></script>

</head>

<body class="invisible">
    <!-- Notice ï¼š All of these modules must import <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/motion-tailwind/motion-tailwind.css" rel="stylesheet">in your header label for using. -->
    <header id="header" class="header-style group"></header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 mb-20">
        <div class="max-w-4xl mx-auto">
            <h1 class="custom-heading text-center mb-8">Create New Course</h1>

            <!-- Course Creation Form -->
            <div class="card card-hover">
                <form id="createCourseForm" class="space-y-6">
                    <!-- Course Basic Information -->
                    <div>
                        <label class="small-heading mb-2">Course Name</label>
                        <input type="text" class="custom-input" required>
                    </div>

                    <div>
                        <label class="small-heading mb-2">Course Code</label>
                        <input type="text" class="custom-input" required>
                    </div>

                    <div>
                        <label class="small-heading mb-2">Course Description</label>
                        <textarea class="custom-input" rows="4" required></textarea>
                    </div>

                    <!-- Score Structure Section -->
                    <div class="space-y-4">
                        <h3 class="small-heading">Course Structure</h3>
                        
                        <div class="relative h-[400px]">
                            <canvas id="scoreChart"></canvas>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="finalExamCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium">Final Exam</label>
                                        <div class="flex items-center space-x-1">
                                            <input type="number" id="finalExamValue" class="w-16 text-sm text-blue-600 border border-gray-300 rounded px-1 py-0.5" 
                                                min="0" max="100" value="0">
                                            <span class="text-sm font-medium text-blue-600">%</span>
                                        </div>
                                    </div>
                                    <input type="range" id="finalExam" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                        min="0" max="100" value="0" required>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="midSemesterExamCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium">Mid-semester Exam</label>
                                        <div class="flex items-center space-x-1">
                                            <input type="number" id="midSemesterExamValue" class="w-16 text-sm text-blue-600 border border-gray-300 rounded px-1 py-0.5" 
                                                min="0" max="100" value="0">
                                            <span class="text-sm font-medium text-blue-600">%</span>
                                        </div>
                                    </div>
                                    <input type="range" id="midSemesterExam" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                        min="0" max="100" value="0" required>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="projectWorkCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium">Project Work</label>
                                        <div class="flex items-center space-x-1">
                                            <input type="number" id="projectWorkValue" class="w-16 text-sm text-blue-600 border border-gray-300 rounded px-1 py-0.5" 
                                                min="0" max="100" value="0">
                                            <span class="text-sm font-medium text-blue-600">%</span>
                                        </div>
                                    </div>
                                    <input type="range" id="projectWork" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                        min="0" max="100" value="0" required>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="assignmentCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium">Assignment</label>
                                        <div class="flex items-center space-x-1">
                                            <input type="number" id="assignmentValue" class="w-16 text-sm text-blue-600 border border-gray-300 rounded px-1 py-0.5" 
                                                min="0" max="100" value="0">
                                            <span class="text-sm font-medium text-blue-600">%</span>
                                        </div>
                                    </div>
                                    <input type="range" id="assignment" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                        min="0" max="100" value="0" required>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="attendanceCheck" class="w-4 h-4 text-blue-600 rounded" checked>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-medium">Attendance</label>
                                        <div class="flex items-center space-x-1">
                                            <input type="number" id="attendanceValue" class="w-16 text-sm text-blue-600 border border-gray-300 rounded px-1 py-0.5" 
                                                min="0" max="100" value="0">
                                            <span class="text-sm font-medium text-blue-600">%</span>
                                        </div>
                                    </div>
                                    <input type="range" id="attendance" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                        min="0" max="100" value="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-medium">Total: <span id="totalPercentage">0</span>%</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-center gap-4">
                        <button class="custom-big-btn">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer section will be kept unchanged -->
    <footer id="footer" class="custom-footer"></footer>

    <script src="/js/components/layout.js"></script>
    <script src="/js/components/file_upload.js"></script>
    <script type="module">
        import { fetchPost } from '/js/components/common.js';

        // Initialize chart
        const ctx = document.getElementById('scoreChart').getContext('2d');
        let scoreChart;

        const allLabels = ['Final Exam', 'Mid-semester Exam', 'Project Work', 'Assignment', 'Attendance'];
        const allColors = [
            'rgba(59, 130, 246, 0.8)',  // blue-500
            'rgba(16, 185, 129, 0.8)',  // emerald-500
            'rgba(245, 158, 11, 0.8)',  // amber-500
            'rgba(139, 92, 246, 0.8)',  // violet-500
            'rgba(236, 72, 153, 0.8)'   // pink-500
        ];
        const allBorderColors = [
            'rgba(59, 130, 246, 1)',    // blue-500
            'rgba(16, 185, 129, 1)',    // emerald-500
            'rgba(245, 158, 11, 1)',    // amber-500
            'rgba(139, 92, 246, 1)',    // violet-500
            'rgba(236, 72, 153, 1)'     // pink-500
        ];

        const initialData = {
            labels: allLabels,
            datasets: [{
                label: 'Course Structure',
                data: [0, 0, 0, 0, 0],
                backgroundColor: allColors,
                borderColor: allBorderColors,
                borderWidth: 2,
                borderRadius: 6,
                barThickness: 40,
                maxBarThickness: 50
            }]
        };

        const config = {
            type: 'bar',
            data: initialData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 20,
                        right: 20
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            color: '#6B7280',
                            padding: 10
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            color: '#6B7280',
                            padding: 10
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1F2937',
                        bodyColor: '#4B5563',
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.raw}%`;
                            },
                            title: function(context) {
                                return context[0].label;
                            }
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const input = document.querySelectorAll('input[type="range"]')[index];
                        input.focus();
                    }
                },
                animation: {
                    duration: 300,
                    easing: 'easeOutQuart'
                }
            }
        };

        scoreChart = new Chart(ctx, config);

        // Add custom styles for range inputs
        const style = document.createElement('style');
        style.textContent = `
            input[type="range"] {
                -webkit-appearance: none;
                height: 8px;
                background: #e5e7eb;
                border-radius: 4px;
                background-image: linear-gradient(#3b82f6, #3b82f6);
                background-repeat: no-repeat;
            }

            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                height: 20px;
                width: 20px;
                border-radius: 50%;
                background: #3b82f6;
                cursor: pointer;
                box-shadow: 0 0 2px 0 #555;
                transition: background .3s ease-in-out;
            }

            input[type="range"]::-webkit-slider-thumb:hover {
                background: #2563eb;
            }

            input[type="range"]:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            input[type="range"]:disabled::-webkit-slider-thumb {
                background: #9ca3af;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(style);

        // Update range input background
        function updateRangeBackground(input) {
            const value = input.value;
            input.style.backgroundSize = `${value}% 100%`;
        }

        // Initialize range inputs and number inputs
        document.querySelectorAll('input[type="range"]').forEach(input => {
            updateRangeBackground(input);
            const valueInput = document.getElementById(`${input.id}Value`);
            
            // Update number input when range changes
            input.addEventListener('input', (e) => {
                updateRangeBackground(e.target);
                valueInput.value = e.target.value;
                updateChart();
            });

            // Update range when number input changes
            valueInput.addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                // Ensure value is between 0 and 100
                value = Math.min(100, Math.max(0, value));
                e.target.value = value;
                input.value = value;
                updateRangeBackground(input);
                updateChart();
            });
        });

        document.querySelectorAll('input[type="checkbox"]').forEach((checkbox, index) => {
            checkbox.addEventListener('change', () => {
                const input = document.querySelectorAll('input[type="range"]')[index];
                const valueInput = document.getElementById(`${input.id}Value`);
                input.disabled = !checkbox.checked;
                valueInput.disabled = !checkbox.checked;
                if (!checkbox.checked) {
                    input.value = 0;
                    valueInput.value = 0;
                    updateRangeBackground(input);
                }
                updateChart();
            });
        });

        // Update chart when input values change
        function updateChart() {
            const inputs = document.querySelectorAll('input[type="range"]');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            
            // Filter enabled components
            const enabledIndices = Array.from(checkboxes)
                .map((checkbox, index) => checkbox.checked ? index : -1)
                .filter(index => index !== -1);

            // Update chart data
            scoreChart.data.labels = enabledIndices.map(index => allLabels[index]);
            scoreChart.data.datasets[0].data = enabledIndices.map(index => parseInt(inputs[index].value) || 0);
            scoreChart.data.datasets[0].backgroundColor = enabledIndices.map(index => allColors[index]);
            scoreChart.data.datasets[0].borderColor = enabledIndices.map(index => allBorderColors[index]);

            scoreChart.update();
            updateTotalPercentage();
        }

        // Update total percentage
        function updateTotalPercentage() {
            const inputs = document.querySelectorAll('input[type="range"]');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const total = Array.from(inputs).reduce((sum, input, index) => {
                return sum + (checkboxes[index].checked ? (parseInt(input.value) || 0) : 0);
            }, 0);
            const totalSpan = document.getElementById('totalPercentage');
            totalSpan.textContent = total;
            
            if (total > 100) {
                totalSpan.classList.add('text-red-500');
            } else {
                totalSpan.classList.remove('text-red-500');
            }
        }

        // Initialize chart with current state
        updateChart();

        // Form submission
        document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const name = form.querySelector('input[type="text"]').value.trim();
            const code = form.querySelectorAll('input[type="text"]')[1].value.trim();
            const description = form.querySelector('textarea').value.trim();

            // Get score structure values
            const finalExam = document.getElementById('finalExamCheck').checked ? 
                parseInt(document.getElementById('finalExam').value) || 0 : 0;
            const midSemesterExam = document.getElementById('midSemesterExamCheck').checked ? 
                parseInt(document.getElementById('midSemesterExam').value) || 0 : 0;
            const projectWork = document.getElementById('projectWorkCheck').checked ? 
                parseInt(document.getElementById('projectWork').value) || 0 : 0;
            const assignment = document.getElementById('assignmentCheck').checked ? 
                parseInt(document.getElementById('assignment').value) || 0 : 0;
            const attendance = document.getElementById('attendanceCheck').checked ? 
                parseInt(document.getElementById('attendance').value) || 0 : 0;

            const totalPercentage = finalExam + midSemesterExam + projectWork + assignment + attendance;

            if (totalPercentage > 100) {
                alert('Total percentage cannot exceed 100%');
                return;
            }

            if (!name || !code || !description) {
                alert('Please complete all fields.');
                return;
            }

            try {
                const response = await fetchPost('/api/courses/create', {
                    name,
                    code,
                    description,
                    scoreStructure: {
                        finalExam,
                        midSemesterExam,
                        projectWork,
                        assignment,
                        attendance
                    }
                });

                console.log('Server response:', response);
                alert('Course created successfully!');
                form.reset();
                updateChart();
            } catch (error) {
                console.error('Failed to create course:', error);
                alert('Failed to create course.');
            }
        });
    </script>

</body>

</html>